# Grafana admin + database secrets
# Preserves existing secret values on upgrade (prevents credential rotation on helm upgrade)
{{- $admin_password := "admin" }}
{{- if .Values.grafana }}
  {{- if .Values.grafana.admin_password }}
    {{- $admin_password = .Values.grafana.admin_password }}
  {{- end }}
{{- end }}

{{- $postgres_username := "postgres" }}
{{- $postgres_password := "postgres" }}
{{- if .Values.postgres }}
  {{- if .Values.postgres.username }}
    {{- $postgres_username = .Values.postgres.username }}
  {{- end }}
  {{- if .Values.postgres.password }}
    {{- $postgres_password = .Values.postgres.password }}
  {{- end }}
{{- end }}

# Preserve existing secret on upgrade
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace "grafana-secrets" }}

{{- if and $existingSecret (hasKey $existingSecret.data "GF_SECURITY_ADMIN_PASSWORD") }}
  {{- $admin_password = b64dec (index $existingSecret.data "GF_SECURITY_ADMIN_PASSWORD") }}
{{- end }}

{{- if and $existingSecret (hasKey $existingSecret.data "GF_DATABASE_USER") }}
  {{- $postgres_username = b64dec (index $existingSecret.data "GF_DATABASE_USER") }}
{{- end }}

{{- if and $existingSecret (hasKey $existingSecret.data "GF_DATABASE_PASSWORD") }}
  {{- $postgres_password = b64dec (index $existingSecret.data "GF_DATABASE_PASSWORD") }}
{{- end }}

apiVersion: v1
kind: Secret
metadata:
  name: grafana-secrets
  annotations:
    meta.helm.sh/release-name: {{ .Release.Name }}
    meta.helm.sh/release-namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/managed-by: Helm
type: Opaque
stringData:
  GF_SECURITY_ADMIN_USER: admin
  GF_SECURITY_ADMIN_PASSWORD: {{ $admin_password }}
  GF_DATABASE_USER: {{ $postgres_username }}
  GF_DATABASE_PASSWORD: {{ $postgres_password }}
