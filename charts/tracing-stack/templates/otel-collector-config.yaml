{{- if .Values.otelCollector.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: {{ .Values.global.namespace | default "observability" }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app: otel-collector
data:
  collector.yaml: |
    receivers:
      # OTLP receiver for gRPC and HTTP
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      
      # Jaeger receiver for legacy support
      jaeger:
        protocols:
          grpc:
            endpoint: 0.0.0.0:14250
          thrift_http:
            endpoint: 0.0.0.0:14268
          thrift_compact:
            endpoint: 0.0.0.0:6831
          thrift_binary:
            endpoint: 0.0.0.0:6832
      
      # Zipkin receiver for legacy support
      zipkin:
        endpoint: 0.0.0.0:9411
      
      # Prometheus metrics for self-monitoring
      prometheus:
        config:
          scrape_configs:
            - job_name: 'otel-collector'
              scrape_interval: 10s
              static_configs:
                - targets: ['localhost:8888']

    processors:
      # Memory limiter to prevent OOM
      memory_limiter:
        check_interval: 5s
        limit_percentage: 80
        spike_limit_percentage: 25
      
      # Batch processor to optimize network usage
      batch:
        timeout: 10s
        send_batch_size: 1024
        send_batch_max_size: 2048
      
      # Only supported processors are listed. Do NOT use "sampling": it is not valid for this collector version.
      probabilistic_sampler:
        sampling_percentage: 100
      
      # Resource detection for cloud metadata
      resourcedetection:
        detectors: [env, system, gcp, azure]
        timeout: 2s

    exporters:
      # Export to Tempo for distributed tracing
      otlp/tempo:
        endpoint: tempo-distributor:4317
        tls:
          insecure: true
      
      # Prometheus exporter for metrics
      prometheus:
        endpoint: 0.0.0.0:8889
        namespace: otelcol
      
      # Logging exporter for debugging
      logging:
        verbosity: detailed
        sampling_initial: 5
        sampling_thereafter: 200

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      pprof:
        endpoint: 0.0.0.0:1777
      zpages:
        endpoint: 0.0.0.0:55679

    service:
      extensions:
        - health_check
        - pprof
        - zpages
      pipelines:
        traces:
          receivers:
            - otlp
            - jaeger
            - zipkin
          processors:
            - memory_limiter
            - batch
            - probabilistic_sampler
            - resourcedetection
          {{- if eq .Values.global.namespace "dev" }}
          exporters:
            - jaeger
            - logging
          {{- else }}
          exporters:
            - otlp/tempo
            - logging
          {{- end }}
        metrics:
          receivers:
            - otlp
            - prometheus
          processors:
            - memory_limiter
            - batch
            - resourcedetection
          exporters:
            - prometheus
{{- end }}
