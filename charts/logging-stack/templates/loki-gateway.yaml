apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-gateway-config
  namespace: {{ .Values.global.namespace | default "observability" }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app: loki
    component: gateway
data:
  nginx.conf: |
    worker_processes  5;  ## Default: 1
    error_log  /dev/stderr;
    pid        /tmp/nginx.pid;
    worker_rlimit_nofile 8192;

    events {
      worker_connections  4096;  ## Default: 1024
    }

    http {
      default_type application/octet-stream;
      log_format   main '$remote_addr - $remote_user [$time_local]  $status '
        '"$request" $body_bytes_sent "$http_referer" '
        '"$http_user_agent" "$http_x_forwarded_for"';
      access_log   /dev/stderr  main;
      
      sendfile     on;
      tcp_nopush   on;


      upstream distributor {
        server loki-distributor.observability.svc.cluster.local:3100;
      }

      upstream query_frontend {
        server loki-query-frontend.observability.svc.cluster.local:3100;
      }

      server {
        listen 8080;

        location = /ready {
          return 200 'OK';
          auth_basic off;
        }

        location = /loki/api/v1/push {
          proxy_pass       http://distributor;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
          proxy_pass       http://query_frontend;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Connection "keep-alive";
          proxy_read_timeout 300;
          proxy_connect_timeout 300;
          proxy_send_timeout 300;
        }
      }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-gateway
  namespace: {{ .Values.global.namespace | default "observability" }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app: loki
    component: gateway
spec:
  replicas: 2
  selector:
    matchLabels:
      app: loki
      component: gateway
  template:
    metadata:
      labels:
        app: loki
        component: gateway
    spec:
      containers:
        - name: nginx
          image: nginx:1.19-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
              name: http
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 15
            timeoutSeconds: 1
          volumeMounts:
            - name: config
              mountPath: /etc/nginx
      volumes:
        - name: config
          configMap:
            name: loki-gateway-config

---
apiVersion: v1
kind: Service
metadata:
  name: loki-gateway
  namespace: {{ .Values.global.namespace | default "observability" }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app: loki
    component: gateway
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3100
      targetPort: http
      protocol: TCP
  selector:
    app: loki
    component: gateway
