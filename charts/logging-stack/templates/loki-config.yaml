apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: {{ .Values.global.namespace | default "observability" }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app: loki
data:
  loki.yaml: |
    auth_enabled: false

    server:
      http_listen_port: 3100
      grpc_listen_port: 9096
      log_level: info
      http_server_read_timeout: 300s
      http_server_write_timeout: 300s
      grpc_server_max_recv_msg_size: 104857600
      grpc_server_max_send_msg_size: 104857600

    memberlist:
      join_members:
        - loki-memberlist.{{ .Release.Namespace }}.svc.cluster.local:7946
      bind_port: 7946

    common:
      path_prefix: /loki
      replication_factor: 3
      storage:
        s3:
          endpoint: {{ .Values.global.objectStorage.endpoint }}
          region: {{ .Values.loki.storage.s3.region }}
          access_key_id: {{ .Values.global.objectStorage.accessKey }}
          secret_access_key: {{ .Values.global.objectStorage.secretKey }}
          insecure: {{ .Values.loki.storage.s3.insecure }}
          s3forcepathstyle: {{ .Values.loki.storage.s3.s3ForcePathStyle }}
          bucketnames: {{ .Values.loki.storage.bucketNames.chunks }}
      ring:
        kvstore:
          store: memberlist
      compactor_address: http://loki-compactor:3100

    schema_config:
      configs:
        - from: 2024-01-01
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: loki_index_
            period: 24h

    storage_config:
      tsdb_shipper:
        active_index_directory: /loki/tsdb-index
        cache_location: /loki/tsdb-cache
        cache_ttl: 24h

    ingester:
      chunk_encoding: {{ .Values.loki.ingester.chunk_encoding | default "snappy" }}
      chunk_idle_period: {{ .Values.loki.ingester.chunk_idle_period | default "30m" }}
      chunk_target_size: {{ .Values.loki.ingester.chunk_target_size | default 1572864 | int }}
      max_chunk_age: {{ .Values.loki.ingester.max_chunk_age | default "1h" }}
      flush_on_shutdown: {{ .Values.loki.ingester.flush_on_shutdown | default true }}
      wal:
        enabled: true
        dir: /loki/wal
      lifecycler:
        ring:
          replication_factor: 3

    querier:
      max_concurrent: {{ .Values.loki.querier.max_concurrent | default 16 }}
      query_ingesters_within: 3h

    query_range:
      align_queries_with_step: {{ .Values.loki.query_range.align_queries_with_step | default true }}
      cache_results: {{ .Values.loki.query_range.cache_results | default true }}
      {{- if .Values.loki.query_range.split_queries_by_interval }}
      split_queries_by_interval: {{ .Values.loki.query_range.split_queries_by_interval }}
      {{- end }}
      {{- if .Values.loki.query_range.parallelise_shardable_queries }}
      parallelise_shardable_queries: {{ .Values.loki.query_range.parallelise_shardable_queries }}
      {{- end }}
      max_retries: {{ .Values.loki.query_range.max_retries | default 5 }}
      results_cache:
        cache:
          embedded_cache:
            enabled: true
            max_size_mb: 100

    limits_config:
      volume_enabled: true
      reject_old_samples: {{ .Values.loki.limits_config.reject_old_samples | default true }}
      reject_old_samples_max_age: {{ .Values.loki.limits_config.reject_old_samples_max_age | default "168h" }}
      retention_period: {{ .Values.loki.limits_config.retention_period | default "168h" }}
      ingestion_rate_mb: {{ .Values.loki.limits_config.ingestion_rate_mb | default 4 }}
      ingestion_burst_size_mb: {{ .Values.loki.limits_config.ingestion_burst_size_mb | default 6 }}
      per_stream_rate_limit: {{ .Values.loki.limits_config.per_stream_rate_limit | default "2MB" }}
      per_stream_rate_limit_burst: {{ .Values.loki.limits_config.per_stream_rate_limit_burst | default "4MB" }}
      max_streams_per_user: {{ .Values.loki.limits_config.max_streams_per_user | default 10000 }}
      max_global_streams_per_user: {{ .Values.loki.limits_config.max_global_streams_per_user | default 50000 }}
      max_query_parallelism: {{ .Values.loki.limits_config.max_query_parallelism | default 32 }}
      max_line_size: {{ .Values.loki.limits_config.max_line_size | default "256kb" }}
      max_line_size_truncate: true
      query_timeout: {{ .Values.loki.limits_config.query_timeout | default "3m" }}

    compactor:
      working_directory: /loki/compactor
      compaction_interval: {{ .Values.loki.compactor.compaction_interval | default "10m" }}
      retention_enabled: true
      retention_delete_delay: {{ .Values.loki.compactor.retention_delete_delay | default "2h" }}
      retention_delete_worker_count: {{ .Values.loki.compactor.retention_delete_worker_count | default 150 }}
      delete_request_store: s3

    ruler:
      storage:
        type: s3
        s3:
          bucketnames: {{ .Values.loki.storage.bucketNames.ruler }}
      rule_path: /loki/rules-temp
      ring:
        kvstore:
          store: memberlist
      enable_api: true

    {{- if .Values.loki.scheduler.enabled }}
    frontend:
      scheduler_address: loki-query-scheduler:9095
    frontend_worker:
      scheduler_address: loki-query-scheduler:9095
    {{- end }}
